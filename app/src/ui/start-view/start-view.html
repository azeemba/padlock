<link rel="import" href="../../styles/shared.html">
<link rel="import" href="../base/base.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../loading-button/loading-button.html">

<dom-module id="pl-start-view">

    <template>

        <style include="shared">
            @keyframes rumble {
                25% {transform: translate(5px, 0);}
                50% {transform: translate(-5px, -3px);}
                75% {transform: translate(5px, 2px);}
            }

            :host {
                --color-background: var(--color-primary);
                --color-foreground: var(--color-tertiary);
                --color-highlight: var(--color-secondary);
                color: var(--color-foreground);
                background: var(--color-background);
                display: flex;
                flex-direction: column;
                text-align: center;
                text-shadow: rgba(0, 0, 0, 0.2) 1px 1px 0;
                @apply --fullbleed;
                z-index: 100;
            }

            .hero {
                display: block;
                height: 150px;
                font-size: 150px;
                width: auto;
                margin: -50px 0 40px 0;
                position: relative;
                z-index: 1;
            }

            pl-input {
                text-align: center;
            }

            pl-input::-webkit-input-placeholder {
                color: inherit;
            }

            #enterButton {
                font-weight: bold;
            }

            .hero.rumble {
                animation: rumble 0.2s;
            }
        </style>

        <div class="spacer"></div>

        <pl-icon id="logo" icon="logo" class="hero"></pl-icon>

        <pl-input id="passwordInput" type="password" placeholder="[[ _inputPlaceholder(_hasData) ]]" class="tap tiles-3"
            on-enter="_enter"></pl-input>

        <pl-loading-button id="enterButton" on-click="_enter" class="tap tiles-4" label="[[ _enterButtonLabel(_hasData) ]]"></pl-loading-button>

        <div class="spacer tiles-5"></div>

    </template>

    <script>
(() => {

class StartView extends padlock.BaseElement {

    static get is() { return "pl-start-view"; }

    static get properties() { return {
        collection: Object,
        localSource: Object,
        settings: {
            type: Object,
            notify: true
        },
        settingsSource: Object,
        _hasData: {
            type: Boolean
        }
    }; }

    ready() {
        super.ready();
        this.reset();
    }

    reset() {
        this.$.passwordInput.value = "";
        this.$.enterButton.stop();
        this._checkHasData();
    }

    _checkHasData() {
        this.localSource.hasData().then((has) => this._hasData = has);
    }

    _enter() {
        this.localSource.password = this.$.passwordInput.value;

        if (this._hasData) {
            this.$.enterButton.start();
            this.collection.fetch(this.localSource).then(() => this._loadSettings(), (e) => {
                if (e.code === "decryption_failed") {
                    this.$.enterButton.fail();
                    this.$.logo.classList.remove("rumble");
                    this.offsetLeft;
                    this.$.logo.classList.add("rumble");
                } else {
                    throw e;
                }
            });
        } else {
            this.$.enterButton.start();
            this.collection.save(this.localSource).then(() => this._loadSettings());
        }
    }

    _loadSettings() {
        this.settingsSource.password = this.localSource.password;
        this.settings.fetch(this.settingsSource)
            .catch(() => this.settings.save(this.settingsSource))
            .then(() => this._decryptSuccess());
    }

    _decryptSuccess() {
        this.$.enterButton.success();
        this.notifyPath("settings");
        this.dispatchEvent(new CustomEvent("unlock"));
    }

    _enterButtonLabel() {
        return this._hasData ? "Unlock" : "Get Started";
    }

    _inputPlaceholder() {
        return this._hasData ? "Enter Password" : "Enter Master Password";
    }

}

window.customElements.define(StartView.is, StartView);

})();
    </script>

</dom-module>
