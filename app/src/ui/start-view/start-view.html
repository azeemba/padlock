<link rel="import" href="../../styles/shared.html">
<link rel="import" href="../base/base.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../loading-button/loading-button.html">

<dom-module id="pl-start-view">

    <template>

        <style include="shared">
            @keyframes rumble {
                25% {transform: translate(2%, 0);}
                50% {transform: translate(-2%, -1%);}
                75% {transform: translate(2%, 1%);}
            }

            :host {
                display: flex;
                flex-direction: column;
                text-align: center;
                @apply --fullbleed;
            }

            .hero {
                margin: -50px 0 40px 0;
            }

            .hero svg {
                margin: 0 auto;
                width: 150px;
                height: 150px;
                fill: currentColor;
            }

            pl-input {
                text-align: center;
            }

            pl-input::-webkit-input-placeholder {
                color: inherit;
            }

            #enterButton {
                font-weight: bold;
            }

            :host([fail]) .hero svg {
                animation: rumble 0.2s;
            }
        </style>

        <div class="spacer"></div>

        <div class="hero">

            <svg viewBox="0 0 1024 1024">
                <defs>
                    <path d="M508,1016 C788.560651,1016 1016,788.560651 1016,508 C1016,227.439347 788.560651,0 508,0 C227.439347,0 0,227.439347 0,508 C0,788.560651 227.439347,1016 508,1016 Z M205.500026,561.237301 C162.938611,564.74096 129.497452,600.393608 129.497452,643.858651 L129.497451,721.255282 C204.113162,853.146739 345.639078,942.163123 507.949057,942.163123 C670.871547,942.163123 812.852814,852.473629 887.242538,719.760295 L887.242538,719.760297 L887.242538,643.858651 C887.242538,600.389025 853.796989,564.740874 811.239964,561.237323 L811.239964,491.475885 C811.239964,324.17138 675.642024,188.53462 508.369994,188.53462 C341.09856,188.53462 205.500026,324.171645 205.500026,491.475885 L205.500026,561.237301 Z M329.845774,560.954745 L686.894214,560.954745 L686.894214,491.475885 C686.894214,392.837673 606.959796,312.880368 508.369994,312.880368 C409.780722,312.880368 329.845774,392.838006 329.845774,491.475885 L329.845774,560.954745 Z" id="path-1"></path>
                    <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="filter-2">
                        <feOffset dx="8" dy="8" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>
                        <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.2 0" type="matrix" in="shadowOffsetOuter1"></feColorMatrix>
                    </filter>
                </defs>
                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="Shape">
                        <use fill="black" fill-opacity="1" filter="url(#filter-2)" xlink:href="#path-1"></use>
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#path-1"></use>
                    </g>
                </g>
            </svg>

        </div>

        <pl-input id="passwordInput" type="password" placeholder="[[ _inputPlaceholder(_hasData) ]]" class="tap tiles-2"
            on-enter="_enter"></pl-input>

        <pl-loading-button id="enterButton" on-click="_enter" class="tap tiles-3" label="[[ _enterButtonLabel(_hasData) ]]"></pl-loading-button>

        <div class="spacer tiles-4"></div>

    </template>

    <script>
(() => {

class StartView extends padlock.BaseElement {

    static get is() { return "pl-start-view"; }

    static get properties() { return {
        collection: Object,
        localSource: Object,
        settings: {
            type: Object,
            notify: true
        },
        settingsSource: Object,
        _hasData: {
            type: Boolean
        }
    }; }

    ready() {
        super.ready();
        this.reset();
    }

    reset() {
        this.$.passwordInput.value = "";
        this.$.enterButton.stop();
        this._checkHasData();
    }

    _checkHasData() {
        this.localSource.hasData().then((has) => this._hasData = has);
    }

    _enter() {
        this.localSource.password = this.$.passwordInput.value;

        if (this._hasData) {
            this.$.enterButton.start();
            this.collection.fetch(this.localSource).then(() => this._loadSettings(), (e) => {
                if (e.code === "decryption_failed") {
                    this.$.enterButton.fail();
                } else {
                    throw e;
                }
            });
        } else {
            this.$.enterButton.start();
            this.collection.save(this.localSource).then(() => this._loadSettings());
        }
    }

    _loadSettings() {
        this.settingsSource.password = this.localSource.password;
        this.settings.fetch(this.settingsSource)
            .catch(() => this.settings.save(this.settingsSource))
            .then(() => this._decryptSuccess());
    }

    _decryptSuccess() {
        this.$.enterButton.success();
        this.notifyPath("settings");
        this.dispatchEvent(new CustomEvent("unlock"));
    }

    _enterButtonLabel() {
        return this._hasData ? "Unlock" : "Get Started";
    }

    _inputPlaceholder() {
        return this._hasData ? "Enter Password" : "Enter Master Password";
    }

}

window.customElements.define(StartView.is, StartView);

})();
    </script>

</dom-module>
