<link rel="import" href="../../styles/shared.html">
<link rel="import" href="../base/base.html">
<link rel="import" href="../dialog/dialog-mixin.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../loading-button/loading-button.html">

<dom-module id="pl-cloud-view">

    <template>

        <style include="shared">
            :host {
                display: flex;
                flex-direction: column;
                @apply --fullbleed;
            }

            button, pl-toggle-button {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }

            .note {
                font-size: var(--font-size-tiny);
                padding: 15px;
                text-align: center;
            }

            .conn-id {
                margin-top: 10px;
                font-weight: bold;
            }

            #emailInput {
                text-align: center;
            }

            #customUrlInput {
                width: 100%;
                padding-left: 15px;
                padding-right: 15px;
            }

            #customUrlInput:not([invalid]) + .warning {
                display: none;
            }

            @media (min-width: 700px) {
                pl-icon[icon=backward] {
                    display: none;
                }
            }
        </style>


        <header class="tiles">
            <pl-icon icon="backward" class="tap" on-click="_back"></pl-icon>
            <div class="title">Padlock Cloud</div>
            <pl-icon icon="refresh" class="tap" on-click=""></pl-icon>
        </header>

        <main>

            <section class="tiles tiles-2" hidden$="[[ _isSet(settings.syncToken) ]]">
                <div class="note">
                    Padlock Cloud provides a convenient way of synchronising your data between all your devices. By
                    securely storing your data in the cloud, it not only allows you to easily access it from anywhere
                    but also acts as a backup in case you should lose your device or accidentally erase your data.
                    Before being sent to our servers, your data is encrypted locally using your master password to make
                    sure that nobody can read it - not even we!
                </div>
                <pl-input id="emailInput" type="email" placeholder="Enter Email Adress" required></pl-input>
                <button class="tap" on-click="_connect">Get Started</button>
            </section>

            <section class="tiles tiles-2" hidden$="[[ !_isActivationPending(settings.syncToken, settings.syncConnected) ]]">
                <div class="note">
                    <strong>Activation pending</strong> - You are almost done connecting this device!
                    An email was sent to <strong>{{ settings.syncEmail }}</strong> with further instructions.
                    Didn't get it? Try again using the button below!
                    <div class="conn-id">Connection ID: {{ settings.syncId }}</div>
                </div>
                <button class="tap" on-click="_cancelConnect">Cancel</button>
            </section>

            <section class="tiles tiles-2" hidden$="[[ !_isTrialing(settings.syncConnected, settings.syncSubStatus) ]]">
                <div class="note">
                    <strong>Your trial period ends in {{ _remainingTrialDays(settings.syncTrialEnd) }} days.</strong>
                    After this period, your access will be read-only, which means you will be able to access
                    your existing data on Padlock Cloud but you won't be able to upload any new data or synchronize
                    changes between devices. Get a subscription now to get unlimited access to Padlock Cloud!
                </div>
                <button class="tap" on-click="_openDashboard">Manage Subscriptions</button>
            </section>

            <section class="tiles tiles-2" hidden$="[[ !_isInactive(settings.syncConnected, settings.syncSubStatus) ]]">
                <div class="note">
                    <strong>Read-Only</strong> -
                    You currently don't have an active subscription! This means you can access
                    your existing data on Padlock Cloud but you won't be able to upload any new data
                    or synchronize changes between devices. Get a subscription now to regain full access
                    to Padlock Cloud!
                </div>
                <button class="tap" on-click="_openDashboard">Manage Subscriptions</button>
            </section>

            <section class="tiles tiles-2" hidden$="[[ !settings.syncConnected ]]">
                <div class="note">
                    <strong>Connected</strong> - This device is connected to the Padlock Cloud account <strong>{{ settings.syncEmail }}</strong>.
                    Connect all your devices with the same account to easily synchronize your data between them!
                    <div class="conn-id">Connection ID: {{ settings.syncId }}</div>
                </div>
                <pl-loading-button id="syncButton" class="tap" on-click="_synchronize" label="Synchronize"></pl-loading-button>
                <button class="tap" on-click="_openDashboard">Manage Account</button>
                <button class="tap" on-click="_disconnect">Disconnect</button>
                <pl-toggle-button active="{{ settings.syncAuto }}" label="Auto Sync" reverse class="tap"></pl-toggle-button>
            </section>

            <section class="tiles tiles-2">
                <div class="note">
                    By providing a custom URL, you can synchronize your data with a server other than the official
                    Padlock Cloud server. <strong>WARNING: This is only recommended for advanced users!</strong>
                </div>
                <pl-toggle-button active="{{ settings.syncCustomHost }}" label="Use Custom Server" reverse
                    on-change="_customHostChanged" class="tap"></pl-toggle-button>
                <div class="tap tiles" hidden$="[[ !settings.syncCustomHost ]]">
                    <pl-input id="customUrlInput" placeholder="Enter Custom URL"
                        value="{{ settings.syncHostUrl }}" pattern="^https://[^\s/$.?#].[^\s]*$"
                        required></pl-input>
                    <div class="note warning">
                        <strong>Invalid URL</strong> - Make sure that the URL is of the form <strong>https://myserver.tld:port</strong>.
                        Note that a <strong>https</strong> connection is strictly required.
                    </div>
                </div>
            </section>

        </main>

    </template>

    <script>
(() => {

class CloudView extends padlock.DialogMixin(padlock.BaseElement) {

    static get is() { return "pl-cloud-view"; }

    static get properties() { return {
        cloudSource: Object,
        collection: Object,
        settings: {
            type: Object,
            notify: true
        },
        _activated: {
            type: Boolean,
            value: false
        }
    }; }

    _back() {
        this.dispatchEvent(new CustomEvent("cloud-back"));
    }

    _disconnect() {
        this.confirm("Are you sure you want to disconnect from Padlock Cloud?", "Disconnect").then((confirmed) => {
            if (confirmed) {
                this.settings.syncConnected = false;
                this.settings.syncToken = "";
                this.settings.syncEmail = "";
                this.settings.syncReadonly = false;
                this.notifyPath("settings");
            }
        });
    }

    _connect() {
        if (this.$.emailInput.invalid) {
            this.alert(this.$.emailInput.validationMessage || "Please enter a valid email address!");
        } else {
            this._requestAuthToken(this.$.emailInput.value.toLowerCase());
        }
    }

    //* Requests an api key from the cloud api with the entered email and device name
    _requestAuthToken(email, create) {
        this.settings.email = email;
        this.settings.syncToken = "";
        this.notifyPath("settings");

        this.cloudSource.source.requestAuthToken(email, create)
            .then((authToken) => {
                // We're getting back the api key directly, but it will valid only
                // after the user has visited the activation link in the email he was sent
                this.settings.syncConnected = false;
                this.settings.syncToken = authToken.token;
                this.settings.syncId = authToken.id;
                this.notifyPath("settings");
                this._testCredentials(true);
                this.alert("Almost done! An email was sent to " + email + " with further instructions.");
            })
            .catch((e) => {
                switch (typeof e === "string" ? e : e.code) {
                    case "account_not_found":
                        this._requestAuthToken(email, true);
                        break;
                    case "rate_limit_exceeded":
                        this.alert("For security reasons only a limited amount of connection request " +
                            "are allowed at a time. Please wait a little before trying again!");
                        break;
                    default:
                        throw e;
                }
                this.notifyPath("settings");
            });
    }

    _isActivationPending() {
        return this.settings.syncToken && !this.settings.syncConnected;
    }

    _isTrialing(connected, s) {
        return connected && s == "trialing";
    }

    _isInactive(connected, s) {
        return connected && s && s != "active" && s != "trialing";
    }

    _testCredentials(poll) {
        this.cloudSource.source.testCredentials().then((connected) => {
            this.settings.syncConnected = connected;

            if (connected) {
                if (poll) {
                    this._connectionSuccess();
                }
            } else {
                if (poll) {
                    clearTimeout(this._testCredsTimeout);
                    this._testCredsTimeout = setTimeout(this._testCredentials.bind(this, true), 3000);
                } else {
                    this.settings.syncToken = "";
                }
            }

            this.notifyPath("settings");
        });
    }

    _stopTestCredentials() {
        clearTimeout(this._testCredsTimeout);
    }

    _isSet(val) {
        return !!val;
    }

    _synchronize() {
        this.$.syncButton.start();
        this.collection.fetch(this.cloudSource)
            .then(() => this.collection.save(this.cloudSource))
            .catch((e) => {
                if (e.code !== "subscription_required") {
                    this.$.syncButton.fail();
                    throw e;
                }
            })
            .then(() => this.$.syncButton.success());
    }

    _connectionSuccess() {
        this.confirm("You successfully paired this device with Padlock Cloud!", "Synchonize Now", "Dismiss")
            .then((confirmed) => {
                if (confirmed) {
                    this._synchronize();
                }
            });
    }

    _customHostChanged() {
        if (this.settings.syncCustomHost) {
            this.confirm("Are you sure you want to use a custom server for synchronization? " +
                "This option is only recommended for advanced users!", "Continue").then((confirmed) => {
                    if (!confirmed) {
                        this.set("settings.syncCustomHost", false);
                    }
                });
        }
    }

    _cancelConnect() {
        this.set("settings.syncToken", "");
        this._stopTestCredentials();
    }

    _openDashboard() {
        window.open(this.settings.syncHostUrl + "/dashboard/", "_system");
    }

    _remainingTrialDays(trialEnd) {
        var now = new Date().getTime() / 1000;
        trialEnd = trialEnd ? parseInt(trialEnd, 10) : now;
        return Math.ceil((trialEnd - now) / 60 / 60 / 24);
    }

}

window.customElements.define(CloudView.is, CloudView);

})();
    </script>

</dom-module>
